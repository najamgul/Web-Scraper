{% extends "base.html" %}

{% block content %}
<h2>Scan Results</h2>

<div class="card">
    <h3>Input: {{ results.input }}</h3>
    <p>Type: {{ results.type }}</p>
    <p>Classification:
        {% set cls = (results.classification or '') %}
        <strong style="color: {{ 'red' if cls == 'Malicious' else ('green' if cls == 'Benign' else '#ff9800') }}">
            {{ cls }}
        </strong>
    </p>
</div>

<hr>

<h3>VirusTotal Report</h3>
{% set vt = results.vt or {} %}
{% set stats = vt.get("last_analysis_stats") or (vt.get("data", {}).get("attributes", {}).get("last_analysis_stats")) %}
{% if stats %}
    <ul>
        <li><strong>Malicious:</strong> {{ stats.malicious }}</li>
        <li><strong>Suspicious:</strong> {{ stats.suspicious }}</li>
        <li><strong>Undetected:</strong> {{ stats.undetected }}</li>
        <li><strong>Harmless:</strong> {{ stats.harmless }}</li>
    </ul>
    <details>
        <summary>Show full VirusTotal JSON</summary>
        <pre style="max-height:360px; overflow:auto; padding:12px; background:#0f172a; color:#e5e7eb; border-radius:8px;">
{{ vt | tojson(indent=2) }}
        </pre>
    </details>
{% else %}
    <p>No VirusTotal data available</p>
{% endif %}

<h3>Shodan Report</h3>
{% set shodan = results.shodan or {} %}
{% if shodan %}
    <ul>
        <li><strong>IP:</strong> {{ shodan.ip_str or shodan.ip or "N/A" }}</li>
        <li><strong>Organization:</strong> {{ shodan.org or "N/A" }}</li>
        <li><strong>ISP:</strong> {{ shodan.isp or "N/A" }}</li>
        <li><strong>Open Ports:</strong>
            {% if shodan.ports %}{{ shodan.ports | join(", ") }}
            {% elif shodan.data %}{{ shodan.data | map(attribute="port") | join(", ") }}
            {% else %}N/A{% endif %}
        </li>
    </ul>
    <details>
        <summary>Show full Shodan JSON</summary>
        <pre style="max-height:360px; overflow:auto; padding:12px; background:#0f172a; color:#e5e7eb; border-radius:8px;">
{{ shodan | tojson(indent=2) }}
        </pre>
    </details>
{% else %}
    <p>No Shodan data available</p>
{% endif %}

<h3>Scraped Data</h3>
{% set scraped = results.scraped or [] %}
{% if scraped and not (scraped | tojson).lower().startswith('[{"title": "no scraped data found"') %}
<pre style="max-height:360px; overflow:auto; padding:12px; background:#0f172a; color:#e5e7eb; border-radius:8px;">
{{ scraped | tojson(indent=2) }}
</pre>
{% else %}
<p>No scraped data found</p>
{% endif %}

<hr>

<h3>Classification Overview (This Result)</h3>
<div style="max-width:360px; min-height:300px;">
    <canvas id="classificationPie"></canvas>
</div>

<h3 style="margin-top: 24px;">VirusTotal Detections</h3>
<div style="max-width:520px; min-height:320px;">
    <canvas id="vtBarChart"></canvas>
</div>

<h3 style="margin-top: 24px;">Overall History (All Results)</h3>
<div style="max-width:360px; min-height:300px;">
    <canvas id="overallPie"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const currentClass = {{ (results.classification or 'Unknown') | tojson }};
const clsLabels = ['Malicious', 'Benign', 'Informational', 'Unknown'];
const clsValues = clsLabels.map(l => l === currentClass ? 1 : 0);

new Chart(document.getElementById('classificationPie'), {
    type: 'pie',
    data: {
        labels: clsLabels,
        datasets: [{
            data: clsValues,
            backgroundColor: ['#e74c3c', '#2ecc71', '#3498db', '#95a5a6']
        }]
    },
    options: { responsive: true, maintainAspectRatio: false }
});

const vtStats = (() => {
    try {
        const vt = {{ (results.vt or {}) | tojson }};
        if (vt.last_analysis_stats) return vt.last_analysis_stats;
        if (vt.data && vt.data.attributes && vt.data.attributes.last_analysis_stats)
            return vt.data.attributes.last_analysis_stats;
        return {};
    } catch (e) { return {}; }
})();
const vtLabels = Object.keys(vtStats);
const vtValues = Object.values(vtStats);

new Chart(document.getElementById('vtBarChart'), {
    type: 'bar',
    data: {
        labels: vtLabels,
        datasets: [{
            label: 'VirusTotal Detection Stats',
            data: vtValues,
            backgroundColor: '#e67e22'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
    }
});

const overallData = {{ chart_data | safe }};
new Chart(document.getElementById('overallPie'), {
    type: 'pie',
    data: {
        labels: overallData.labels,
        datasets: [{
            data: overallData.values,
            backgroundColor: ['#e74c3c', '#2ecc71', '#3498db', '#95a5a6']
        }]
    },
    options: { responsive: true, maintainAspectRatio: false }
});
</script>
{% endblock %}
