<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

<!-- Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='results.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='responsive.css') }}">
    <title>Scan Results - 3D Threat Intelligence Scanner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<script>
    try {
        const loadingOverlay = window.opener?.document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.classList.remove('active');
        }
    } catch (e) {
        console.log('Loading overlay not found (expected on direct page load)');
    }
</script>

<body>
    <div class="bg-cubes">
        <div class="cube"></div>
        <div class="cube"></div>
        <div class="cube"></div>
        <div class="cube"></div>
    </div>
    
    <div class="container">
        <header>
            <a href="{{ url_for('main.index') }}" class="back-btn">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>Scan Results</h1>
        </header>
        
        <div class="summary-card">
            <div class="summary-item">
                <span class="summary-label">Input</span>
                <span class="summary-value">{{ results.input }}</span>
            </div>
            
            <div class="summary-item">
                <span class="summary-label">Type</span>
                <span class="summary-value">{{ results.type }}</span>
            </div>
            
            <div class="summary-item">
                <span class="summary-label">Classification</span>
                    <span class="summary-value">
                        <span class="classification" id="classification-badge">
                            <i class="fas fa-spinner fa-spin"></i> Analyzing...
                        </span>
                    </span>
                </div>
            </div>
    <!-- ========================================= -->
<!-- ✅ AI THREAT CONTEXT ENRICHMENT SECTION -->
<!-- ONLY LOADS AFTER CLASSIFICATION COMPLETES -->
<!-- ========================================= -->
<div id="enrichment-container" style="
    background: linear-gradient(135deg, rgba(67, 97, 238, 0.15) 0%, rgba(76, 201, 240, 0.15) 100%);
    border-left: 5px solid #4361ee;
    border-radius: 20px;
    padding: 3rem;
    margin: 3rem 0;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    transform: perspective(1000px) rotateX(5deg);
    transition: transform 0.5s ease;
    border: 1px solid rgba(67, 97, 238, 0.3);
">
    <h2 style="
        color: #4cc9f0;
        font-size: 2rem;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    ">
        <i class="fas fa-brain"></i> AI Threat Analysis
    </h2>
    
    <!-- ✅ Loading State (Initially Hidden) -->
    <div id="enrichment-loading" style="display: none; text-align: center; padding: 3rem;">
        <div style="
            width: 60px;
            height: 60px;
            border: 5px solid rgba(76, 201, 240, 0.2);
            border-top: 5px solid #4cc9f0;
            border-radius: 50%;
            margin: 0 auto 1.5rem;
            animation: spin 1s linear infinite;
        "></div>
        <p id="enrichment-loading-text" style="font-size: 1.2rem; color: #94a3b8;">
            <i class="fas fa-robot"></i> AI is analyzing threat data...
        </p>
        <p style="font-size: 0.9rem; color: #64748b; margin-top: 0.5rem;">
            This may take 5-15 seconds
        </p>
    </div>
    
    <!-- ✅ Waiting State (Initially Shown) -->
    <div id="enrichment-waiting" style="text-align: center; padding: 3rem;">
        <i class="fas fa-hourglass-half" style="font-size: 3rem; color: #4cc9f0; margin-bottom: 1rem;"></i>
        <p style="font-size: 1.2rem; color: #94a3b8;">
            Waiting for classification to complete...
        </p>
        <p style="font-size: 0.9rem; color: #64748b; margin-top: 0.5rem;">
            AI analysis will start after OTX data loads
        </p>
    </div>
    
    <!-- ✅ Content (Hidden Initially) -->
    <div id="enrichment-content" style="display: none;">
        <!-- Will be populated via AJAX -->
    </div>
    
    <!-- ✅ Error State (Hidden Initially) -->
    <div id="enrichment-error" style="display: none; text-align: center; padding: 2rem;">
        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f39c12; margin-bottom: 1rem;"></i>
        <p style="font-size: 1.1rem; color: #e2e8f0;">AI analysis unavailable</p>
        <p style="font-size: 0.9rem; color: #94a3b8;" id="enrichment-error-message"></p>
    </div>
</div>
        


<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<!-- ✅ NOTE: AI Enrichment is loaded by the sequential loading system below (OTX → Classification → Enrichment) -->
        <!-- END AI THREAT CONTEXT ENRICHMENT         -->
        <!-- ========================================= -->
        
        <h2 class="section-title"><i class="fas fa-shield-virus"></i> VirusTotal Report</h2>
        
        {% set vt = results.vt or {} %}
        {% set stats = vt.get("last_analysis_stats") or (vt.get("data", {}).get("attributes", {}).get("last_analysis_stats")) %}
        
        <div class="report-card">
            {% if stats %}
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value malicious-stat">{{ stats.malicious }}</div>
                    <div class="stat-label">Malicious</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value suspicious-stat">{{ stats.suspicious }}</div>
                    <div class="stat-label">Suspicious</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value undetected-stat">{{ stats.undetected }}</div>
                    <div class="stat-label">Undetected</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value harmless-stat">{{ stats.harmless }}</div>
                    <div class="stat-label">Harmless</div>
                </div>
            </div>
            
            <details>
                <summary>View full VirusTotal JSON data</summary>
                <pre class="json-view">{{ vt | tojson(indent=2) }}</pre>
            </details>
            {% else %}
            <div class="no-data">
                <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 1.5rem;"></i>
                <p>No VirusTotal data available</p>
            </div>
            {% endif %}
        </div>
        
        <h2 class="section-title"><i class="fas fa-search-location"></i> Shodan Report</h2>
        
        {% set shodan = results.shodan or {} %}
        
        <div class="report-card">
            {% if shodan and 'error' not in shodan and (shodan.ip_str or shodan.ip or shodan.org or shodan.ports or shodan.data) %}
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">{{ shodan.ip_str or shodan.ip or "N/A" }}</div>
                    <div class="stat-label">IP Address</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ shodan.org or "N/A" }}</div>
                    <div class="stat-label">Organization</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ shodan.isp or "N/A" }}</div>
                    <div class="stat-label">ISP</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">
                        {% if shodan.ports %}{{ shodan.ports | length }}
                        {% elif shodan.data %}{{ shodan.data | length }}
                        {% else %}0{% endif %}
                    </div>
                    <div class="stat-label">Open Ports</div>
                </div>
            </div>
            
            {% if shodan.ports or shodan.data %}
            <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(15, 23, 42, 0.5); border-radius: 15px;">
                <strong style="color: #4cc9f0; font-size: 1.1rem;">Open Ports:</strong>
                <span style="font-family: monospace; color: #e2e8f0; margin-left: 1rem;">
                    {% if shodan.ports %}{{ shodan.ports | join(", ") }}
                    {% elif shodan.data %}{{ shodan.data | map(attribute="port") | join(", ") }}
                    {% else %}N/A{% endif %}
                </span>
            </div>
            {% endif %}
            
            <details>
                <summary>View full Shodan JSON data</summary>
                <pre class="json-view">{{ shodan | tojson(indent=2) }}</pre>
            </details>
            {% else %}
            <div class="no-data">
                <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 1.5rem;"></i>
                {% if shodan.error %}
                <p>{{ shodan.error }}</p>
                {% if shodan.info %}
                <p style="font-size: 0.9rem; margin-top: 0.5rem; color: #94a3b8;">{{ shodan.info }}</p>
                {% endif %}
                {% else %}
                <p>No Shodan data available (Shodan only supports IP addresses)</p>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- ========================================= -->
        <!-- 🛡️ ABUSEIPDB SECTION -->
        <!-- ========================================= -->
        <h2 class="section-title"><i class="fas fa-shield-alt"></i> AbuseIPDB Reputation Report</h2>
        
        {% set abuseipdb = results.abuseipdb or {} %}
        
        <div class="report-card">
            {% if abuseipdb and 'error' not in abuseipdb and (abuseipdb.ip_address or abuseipdb.abuse_confidence_score is defined) %}
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">{{ abuseipdb.ip_address or "N/A" }}</div>
                    <div class="stat-label">IP Address</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" style="{% if abuseipdb.abuse_confidence_score >= 75 %}color: #ef4444;{% elif abuseipdb.abuse_confidence_score >= 50 %}color: #f59e0b;{% elif abuseipdb.abuse_confidence_score >= 25 %}color: #eab308;{% else %}color: #10b981;{% endif %}">
                        {{ abuseipdb.abuse_confidence_score or 0 }}%
                    </div>
                    <div class="stat-label">Abuse Confidence</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ abuseipdb.total_reports or 0 }}</div>
                    <div class="stat-label">Total Reports</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">
                        {% if abuseipdb.is_whitelisted %}
                            <span style="color: #10b981;">✓ Whitelisted</span>
                        {% else %}
                            <span style="color: #94a3b8;">Not Whitelisted</span>
                        {% endif %}
                    </div>
                    <div class="stat-label">Status</div>
                </div>
            </div>
            
            <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(15, 23, 42, 0.5); border-radius: 15px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    <div>
                        <strong style="color: #4cc9f0; font-size: 0.95rem;">Country:</strong>
                        <span style="color: #e2e8f0; margin-left: 0.5rem;">{{ abuseipdb.country_code or "Unknown" }}</span>
                    </div>
                    <div>
                        <strong style="color: #4cc9f0; font-size: 0.95rem;">ISP:</strong>
                        <span style="color: #e2e8f0; margin-left: 0.5rem;">{{ abuseipdb.isp or "Unknown" }}</span>
                    </div>
                    <div>
                        <strong style="color: #4cc9f0; font-size: 0.95rem;">Usage Type:</strong>
                        <span style="color: #e2e8f0; margin-left: 0.5rem;">{{ abuseipdb.usage_type or "Unknown" }}</span>
                    </div>
                    <div>
                        <strong style="color: #4cc9f0; font-size: 0.95rem;">Domain:</strong>
                        <span style="color: #e2e8f0; margin-left: 0.5rem;">{{ abuseipdb.domain or "N/A" }}</span>
                    </div>
                </div>
            </div>
            
            {% if abuseipdb.categories %}
            <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(15, 23, 42, 0.5); border-radius: 15px;">
                <strong style="color: #4cc9f0; font-size: 1.1rem;">Reported Categories:</strong>
                <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1rem;">
                    {% for category, count in abuseipdb.categories.items() %}
                    <span style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; border: 1px solid rgba(239, 68, 68, 0.3);">
                        {{ category }} ({{ count }})
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if abuseipdb.last_reported %}
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(67, 97, 238, 0.1); border-left: 4px solid #4361ee; border-radius: 8px;">
                <span style="color: #94a3b8; font-size: 0.9rem;">Last Reported: {{ abuseipdb.last_reported }}</span>
            </div>
            {% endif %}
            
            <details>
                <summary>View full AbuseIPDB JSON data</summary>
                <pre class="json-view">{{ abuseipdb | tojson(indent=2) }}</pre>
            </details>
            {% else %}
            <div class="no-data">
                <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 1.5rem;"></i>
                {% if abuseipdb.error %}
                <p>{{ abuseipdb.error }}</p>
                {% if abuseipdb.info %}
                <p style="font-size: 0.9rem; margin-top: 0.5rem; color: #94a3b8;">{{ abuseipdb.info }}</p>
                {% endif %}
                {% else %}
                <p>No AbuseIPDB data available (AbuseIPDB only supports IP addresses)</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
        
        <!-- ========================================= -->
<!-- ✅ OTX SECTION WITH LAZY LOADING -->
<!-- ========================================= -->
<h2 class="section-title"><i class="fas fa-database"></i> AlienVault OTX Threat Intelligence</h2>

<div class="report-card" id="otx-container">
    <!-- ✅ Loading State (Initially Visible) -->
    <div id="otx-loading" style="text-align: center; padding: 3rem;">
        <div style="
            width: 60px;
            height: 60px;
            border: 5px solid rgba(76, 201, 240, 0.2);
            border-top: 5px solid #4cc9f0;
            border-radius: 50%;
            margin: 0 auto 1.5rem;
            animation: spin 1s linear infinite;
        "></div>
        <p style="font-size: 1.2rem; color: #94a3b8;">
            <i class="fas fa-satellite-dish"></i> Fetching OTX threat intelligence...
        </p>
        <p style="font-size: 0.9rem; color: #64748b; margin-top: 0.5rem;">
            This may take 10-20 seconds for keywords
        </p>
    </div>
    
    <!-- ✅ Content (Hidden Initially) -->
    <div id="otx-content" style="display: none;">
        <!-- Will be populated via AJAX -->
    </div>
    
    <!-- ✅ Error State (Hidden Initially) -->
    <div id="otx-error" style="display: none; text-align: center; padding: 2rem;">
        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f39c12; margin-bottom: 1rem;"></i>
        <p style="font-size: 1.1rem; color: #e2e8f0;">OTX data unavailable</p>
        <p style="font-size: 0.9rem; color: #94a3b8;" id="otx-error-message"></p>
    </div>
</div>
        
    <h2 class="section-title"><i class="fas fa-search"></i> Google Search Intelligence</h2>

{% set google_fmt = results.google_formatted %}

<div class="report-card">
    {% if google_fmt %}
        <!-- Threat Score Progress Bar -->
        <div style="margin-bottom: 3rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span style="font-size: 1.2rem; font-weight: 600; color: #4cc9f0;">
                    <i class="fas fa-chart-line"></i> Search Intelligence Score
                </span>
                <span style="font-size: 1.5rem; font-weight: 700; color: #e2e8f0;">
                    {{ google_fmt.threat_score }}/100
                </span>
            </div>
            <div style="background: rgba(15, 23, 42, 0.7); border-radius: 50px; height: 30px; overflow: hidden; box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);">
                <div style="
                    height: 100%; 
                    width: 0%;
                    background: linear-gradient(90deg, #3498db, #2980b9);
                    transition: width 1s ease;
                    display: flex;
                    align-items: center;
                    justify-content: flex-end;
                    padding-right: 15px;
                    color: white;
                    font-weight: 600;" id="threatScoreBar"></div>
            </div>
        </div>

        <!-- Summary Card -->
        <div style="background: rgba(67, 97, 238, 0.1); border-left: 4px solid #4361ee; padding: 1.5rem; border-radius: 12px; margin-bottom: 2.5rem;">
            <p style="font-size: 1.1rem; color: #e2e8f0; margin: 0;">
                <i class="fas fa-info-circle" style="color: #4cc9f0; margin-right: 0.5rem;"></i>
                <span id="summaryText"></span>
            </p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="classificationValue" style="color: #2ecc71;">
                </div>
                <div class="stat-label">Risk Classification</div>
            </div>

            <div class="stat-item">
                <div class="stat-value" id="riskLevelValue" style="color: #2ecc71;">
                    {{ google_fmt.risk_level }}
                </div>
                <div class="stat-label">Risk Level</div>
            </div>

            <div class="stat-item">
                <div class="stat-value" style="color: #4cc9f0;">
                    {{ google_fmt.result_count }}
                </div>
                <div class="stat-label">Search Results</div>
            </div>

            <div class="stat-item">
                <div class="stat-value" style="color: #9f7aea;">
                    {{ google_fmt.total_domains }}
                </div>
                <div class="stat-label">Unique Domains</div>
            </div>
        </div>

        <!-- Threat Indicators -->
        {% if google_fmt.threat_indicators %}
        <div style="margin-top: 2.5rem; padding: 2rem; background: rgba(231, 76, 60, 0.1); border-radius: 15px; border: 1px solid rgba(231, 76, 60, 0.3);">
            <h4 style="color: #e74c3c; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.8rem;">
                <i class="fas fa-exclamation-triangle"></i> Threat Indicators Found
            </h4>
            <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                {% for indicator in google_fmt.threat_indicators %}
                <span style="
                    background: linear-gradient(135deg, #e74c3c, #c0392b);
                    color: white;
                    padding: 0.6rem 1.2rem;
                    border-radius: 20px;
                    font-size: 0.95rem;
                    font-weight: 600;
                    box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
                ">
                    <i class="fas fa-flag"></i> {{ indicator }}
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Safe Indicators -->
        {% if google_fmt.safe_indicators %}
        <div style="margin-top: 2.5rem; padding: 2rem; background: rgba(46, 204, 113, 0.1); border-radius: 15px; border: 1px solid rgba(46, 204, 113, 0.3);">
            <h4 style="color: #2ecc71; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.8rem;">
                <i class="fas fa-shield-check"></i> Safety Indicators
            </h4>
            <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                {% for indicator in google_fmt.safe_indicators %}
                <span style="
                    background: linear-gradient(135deg, #2ecc71, #27ae60);
                    color: white;
                    padding: 0.6rem 1.2rem;
                    border-radius: 20px;
                    font-size: 0.95rem;
                    font-weight: 600;
                    box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
                ">
                    <i class="fas fa-check-circle"></i> {{ indicator }}
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Domains Found -->
        {% if google_fmt.unique_domains %}
        <div style="margin-top: 2.5rem; padding: 2rem; background: rgba(15, 23, 42, 0.5); border-radius: 15px;">
            <h4 style="color: #4cc9f0; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.8rem;">
                <i class="fas fa-globe"></i> Domains Referenced
            </h4>
            <div style="display: flex; flex-wrap: wrap; gap: 0.8rem;">
                {% for domain in google_fmt.unique_domains %}
                <span style="
                    background: rgba(76, 201, 240, 0.2);
                    color: #4cc9f0;
                    padding: 0.5rem 1rem;
                    border-radius: 15px;
                    font-size: 0.9rem;
                    border: 1px solid rgba(76, 201, 240, 0.3);
                    font-family: monospace;
                ">
                    {{ domain }}
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Top Search Results -->
        {% if google_fmt.top_results %}
        <div style="margin-top: 2.5rem; padding: 2rem; background: rgba(15, 23, 42, 0.5); border-radius: 15px;">
            <h4 style="color: #9f7aea; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.8rem;">
                <i class="fas fa-list-ol"></i> Top Search Results
            </h4>
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                {% for result in google_fmt.top_results %}
                <div style="
                    background: rgba(30, 41, 59, 0.6);
                    padding: 1.5rem;
                    border-radius: 12px;
                    border-left: 3px solid #9f7aea;
                    transition: all 0.3s ease;
                " onmouseover="this.style.background='rgba(30, 41, 59, 0.8)'" onmouseout="this.style.background='rgba(30, 41, 59, 0.6)'">
                    <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 0.8rem;">
                        <i class="fas fa-link" style="color: #9f7aea; margin-top: 0.3rem;"></i>
                        <div style="flex: 1;">
                            <h5 style="font-size: 1.2rem; font-weight: 600; color: #e2e8f0; margin-bottom: 0.5rem;">
                                {{ result.title }}
                            </h5>
                            <a href="{{ result.url }}" target="_blank" style="
                                color: #4cc9f0;
                                text-decoration: none;
                                font-size: 0.9rem;
                                word-break: break-all;
                            " onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                                {{ result.url }}
                            </a>
                        </div>
                    </div>
                    <div style="padding-left: 2rem;">
                        <span style="
                            display: inline-block;
                            background: rgba(76, 201, 240, 0.2);
                            color: #4cc9f0;
                            padding: 0.3rem 0.8rem;
                            border-radius: 12px;
                            font-size: 0.85rem;
                            margin-bottom: 0.8rem;
                        ">
                            {{ result.domain }}
                        </span>
                        <p style="color: #cbd5e1; line-height: 1.6; margin: 0;">
                            {{ result.snippet }}
                        </p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Content Previews -->
        {% if google_fmt.content_previews %}
        <div style="margin-top: 2.5rem; padding: 2rem; background: rgba(15, 23, 42, 0.5); border-radius: 15px;">
            <h4 style="color: #48bb78; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.8rem;">
                <i class="fas fa-file-alt"></i> Content Analysis
            </h4>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for preview in google_fmt.content_previews %}
                <div style="
                    background: rgba(255, 255, 255, 0.05);
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    border-left: 2px solid #48bb78;
                ">
                    <p style="color: #cbd5e1; line-height: 1.6; margin: 0; font-style: italic;">
                        "{{ preview }}"
                    </p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Raw JSON (Collapsible) -->
        <details style="margin-top: 3rem;">
            <summary>View Raw Search Data (JSON)</summary>
            <pre class="json-view">{{ google_fmt.raw | tojson(indent=2) }}</pre>
        </details>

    {% else %}
        <div class="no-data">
            <i class="fas fa-info-circle" style="font-size: 3rem; margin-bottom: 1.5rem;"></i>
            <p>No Google search data available</p>
            <p style="font-size: 0.9rem; color: #94a3b8; margin-top: 0.5rem;">
                This IOC type may not support web search intelligence
            </p>
        </div>
    {% endif %}
</div>
        
        
        <div class="chart-grid">
            <div class="chart-container">
                <div class="chart-title">Classification Overview</div>
                <div class="chart-wrapper">
                    <canvas id="classificationPie"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">VirusTotal Detections</div>
                <div class="chart-wrapper">
                    <canvas id="vtBarChart"></canvas>
                </div>
            </div>
            
            {% if otx_fmt %}
            <div class="chart-container">
                <div class="chart-title">OTX Threat Analysis</div>
                <div class="chart-wrapper">
                    <canvas id="otxChart"></canvas>
                </div>
            </div>
            {% endif %}
            
            <div class="chart-container">
                <div class="chart-title">Overall History (All Results)</div>
                <div class="chart-wrapper">
                    <canvas id="overallPie"></canvas>
                </div>
            </div>
        </div>

        <div class="export-links">
            <h3 style="margin-bottom: 1.5rem; color: #e2e8f0;">Export Results</h3>
            <a href="{{ url_for('main.export', format='csv', ioc_id=results.ioc_id) }}">
                <i class="fas fa-file-csv"></i> Export CSV
            </a>
            <a href="{{ url_for('main.export', format='json', ioc_id=results.ioc_id) }}">
                <i class="fas fa-file-code"></i> Export JSON
            </a>
            <a href="{{ url_for('main.export', format='excel', ioc_id=results.ioc_id) }}">
                <i class="fas fa-file-excel"></i> Export Excel
            </a>
            <a href="{{ url_for('main.export', format='pdf', ioc_id=results.ioc_id) }}">
                <i class="fas fa-file-pdf"></i> Export PDF
            </a>
        </div>
        
        <footer>
            <p>© 2025 Developed by Students of Computer Engineering Deptt. | Pillai College of Engineering</p>
        </footer>
    </div>

    <script>
    const chartState = { classificationChart: null, vtBarChart: null, overallPieChart: null };
    let currentClassification = "{{ results.classification|default('Unknown', true) }}";
    const rawVtData = {{ (results.vt or {}) | tojson | safe }};
    const overallData = JSON.parse({{ chart_data | tojson | safe }});
    
    // ✅ Check for pre-loaded enrichment data (from /scan endpoint)
    const preloadedEnrichment = {{ (results.llm_analysis or results.enrichment or {}) | tojson | safe }};

    function extractVtStats(data) {
        if (!data) return {};
        if (data.last_analysis_stats) return data.last_analysis_stats;
        if (data.data && data.data.attributes && data.data.attributes.last_analysis_stats) {
            return data.data.attributes.last_analysis_stats;
        }
        return {};
    }

    function renderStaticCharts() {
        const clsLabels = ['Malicious', 'Benign', 'Informational', 'Unknown'];
        const clsValues = clsLabels.map(label => label === currentClassification ? 1 : 0);
        const classificationCanvas = document.getElementById('classificationPie');

        if (classificationCanvas) {
            if (!chartState.classificationChart) {
                chartState.classificationChart = new Chart(classificationCanvas, {
                    type: 'pie',
                    data: { labels: clsLabels, datasets: [{ data: clsValues, backgroundColor: ['#e74c3c', '#2ecc71', '#3498db', '#95a5a6'] }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#e2e8f0', font: { size: 14 } } }
                        }
                    }
                });
            } else {
                chartState.classificationChart.data.datasets[0].data = clsValues;
                chartState.classificationChart.update();
            }
        }

        const vtStats = extractVtStats(rawVtData);
        const vtCanvas = document.getElementById('vtBarChart');
        if (vtCanvas) {
            if (Object.keys(vtStats).length === 0) {
                vtCanvas.parentElement.innerHTML = '<div class="no-data"><p>No VirusTotal data available for chart</p></div>';
            } else if (!chartState.vtBarChart) {
                chartState.vtBarChart = new Chart(vtCanvas, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(vtStats),
                        datasets: [{ label: 'VirusTotal Detection Stats', data: Object.values(vtStats), backgroundColor: ['#e74c3c', '#f39c12', '#95a5a6', '#2ecc71'] }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { precision: 0, color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            x: { ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                        }
                    }
                });
            }
        }

        const overallCanvas = document.getElementById('overallPie');
        if (overallCanvas) {
            if (!overallData || !overallData.labels || !overallData.values) {
                overallCanvas.parentElement.innerHTML = '<div class="no-data"><p>No historical data available</p></div>';
            } else if (!chartState.overallPieChart) {
                chartState.overallPieChart = new Chart(overallCanvas, {
                    type: 'pie',
                    data: { labels: overallData.labels, datasets: [{ data: overallData.values, backgroundColor: ['#e74c3c', '#2ecc71', '#3498db', '#95a5a6'] }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { color: '#e2e8f0', font: { size: 14 } } } }
                    }
                });
            }
        }
    }

    function createOTXChart(otx_fmt) {
        console.log('📊 Creating OTX chart with data:', otx_fmt);
        const otxChartElement = document.getElementById('otxChart');
        if (!otx_fmt || typeof otx_fmt.threat_score === 'undefined' || !otxChartElement) {
            if (otxChartElement) {
                otxChartElement.parentElement.innerHTML = '<div class="no-data"><p>No OTX data available for chart</p></div>';
            }
            return;
        }

        if (window.otxChart) {
            window.otxChart.destroy();
        }

        const threatScore = Number(otx_fmt.threat_score || 0);
        window.otxChart = new Chart(otxChartElement, {
            type: 'doughnut',
            data: {
                labels: ['Threat Score', 'Safe Score'],
                datasets: [{
                    data: [threatScore, 100 - threatScore],
                    backgroundColor: [
                        threatScore >= 70 ? '#e74c3c' :
                        threatScore >= 40 ? '#f39c12' :
                        threatScore >= 10 ? '#3498db' : '#2ecc71',
                        'rgba(148, 163, 184, 0.2)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                cutout: '70%',
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: '#e2e8f0', font: { size: 14 } } },
                    tooltip: { callbacks: { label: context => `${context.label}: ${context.parsed}/100` } }
                }
            },
            plugins: [{
                beforeDraw: function(chart) {
                    const ctx = chart.ctx;
                    const { width, height } = chart;
                    ctx.save();
                    ctx.font = `${(height / 80).toFixed(2)}em sans-serif`;
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#e2e8f0';
                    const text = `${threatScore}/100`;
                    ctx.fillText(text, (width - ctx.measureText(text).width) / 2, height / 2);
                    ctx.restore();
                }
            }]
        });
    }

    function buildOTXHTML(otx_fmt) {
        console.log('🎨 Building OTX HTML...');
        setTimeout(() => createOTXChart(otx_fmt), 500);
        return `
        <!-- Threat Score Progress Bar -->
        <div style="margin-bottom: 3rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <span style="font-size: 1.2rem; font-weight: 600; color: #4cc9f0;">
                    <i class="fas fa-exclamation-triangle"></i> Threat Score
                </span>
                <span style="font-size: 1.5rem; font-weight: 700; color: #e2e8f0;">
                    ${otx_fmt.threat_score}/100
                </span>
            </div>
            <div style="background: rgba(15, 23, 42, 0.7); border-radius: 50px; height: 30px; overflow: hidden; box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);">
                <div style="
                    height: 100%;
                    width: ${otx_fmt.threat_score}%;
                    background: ${otx_fmt.threat_score >= 70 ? 'linear-gradient(90deg, #e74c3c, #c0392b)' :
                                 otx_fmt.threat_score >= 40 ? 'linear-gradient(90deg, #f39c12, #e67e22)' :
                                 otx_fmt.threat_score >= 10 ? 'linear-gradient(90deg, #3498db, #2980b9)' :
                                 'linear-gradient(90deg, #2ecc71, #27ae60)'};
                    transition: width 1s ease;
                "></div>
            </div>
        </div>

        <!-- Summary -->
        <div style="background: rgba(67, 97, 238, 0.1); border-left: 4px solid #4361ee; padding: 1.5rem; border-radius: 12px; margin-bottom: 2.5rem;">
            <p style="font-size: 1.1rem; color: #e2e8f0; margin: 0;">
                <i class="fas fa-info-circle" style="color: #4cc9f0; margin-right: 0.5rem;"></i>
                ${otx_fmt.summary}
            </p>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" style="color: ${
                    otx_fmt.classification === 'Malicious' ? '#e74c3c' :
                    otx_fmt.classification === 'Suspicious' ? '#f39c12' :
                    otx_fmt.classification === 'Informational' ? '#3498db' : '#2ecc71'
                };">
                    ${otx_fmt.classification}
                </div>
                <div class="stat-label">Classification</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">${otx_fmt.source_count}</div>
                <div class="stat-label">Threat Pulses</div>
            </div>
        </div>

        <details style="margin-top: 2rem;">
            <summary>View Raw OTX Data (JSON)</summary>
            <pre class="json-view">${JSON.stringify(otx_fmt.raw, null, 2)}</pre>
        </details>
        `;
    }

    function buildEnrichmentHTML(enrichment, classification) {
        console.log('🎨 Building Enrichment HTML...');
        let html = '';
        
        // Summary
        if (enrichment.summary) {
            html += `
            <div style="
                font-size: 1.2rem;
                margin-bottom: 2.5rem;
                padding: 1.5rem;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 12px;
                line-height: 1.8;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            ">
                <i class="fas fa-quote-left" style="color: #4cc9f0; opacity: 0.5; margin-right: 0.5rem;"></i>
                ${enrichment.summary}
                <i class="fas fa-quote-right" style="color: #4cc9f0; opacity: 0.5; margin-left: 0.5rem;"></i>
            </div>
            `;
        }
        
        // Why Malicious/Benign
        if (enrichment.why_malicious) {
            let iconClass = 'fa-info-circle';
            let color = '#f39c12';
            
            if (classification === 'Malicious') {
                iconClass = 'fa-exclamation-triangle';
                color = '#e74c3c';
            } else if (classification === 'Benign') {
                iconClass = 'fa-shield-check';
                color = '#2ecc71';
            }
            
            html += `
            <div style="
                background: rgba(15, 23, 42, 0.6);
                padding: 2rem;
                border-radius: 15px;
                margin-bottom: 2.5rem;
                border: 1px solid rgba(255, 255, 255, 0.1);
            ">
                <h3 style="
                    color: ${color};
                    font-size: 1.5rem;
                    margin-bottom: 1.5rem;
                    display: flex;
                    align-items: center;
                    gap: 0.8rem;
                ">
                    <i class="fas ${iconClass}"></i> Analysis Details
                </h3>
                <div style="white-space: pre-line; line-height: 1.8; color: #e2e8f0;">
                    ${enrichment.why_malicious}
                </div>
            </div>
            `;
        }
        
        // Key Indicators
        if (enrichment.key_indicators && enrichment.key_indicators.length > 0) {
            html += `
            <div style="margin-bottom: 2.5rem;">
                <h3 style="
                    color: #f39c12;
                    font-size: 1.5rem;
                    margin-bottom: 1.5rem;
                    display: flex;
                    align-items: center;
                    gap: 0.8rem;
                ">
                    <i class="fas fa-list-check"></i> Key Threat Indicators
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
            `;
            
            enrichment.key_indicators.forEach(indicator => {
                html += `
                <div style="
                    background: rgba(243, 156, 18, 0.1);
                    padding: 1.2rem;
                    border-left: 3px solid #f39c12;
                    border-radius: 8px;
                    display: flex;
                    align-items: start;
                    gap: 1rem;
                ">
                    <i class="fas fa-check-circle" style="color: #f39c12; margin-top: 0.2rem; font-size: 1.2rem;"></i>
                    <span>${indicator}</span>
                </div>
                `;
            });
            
            html += `</div></div>`;
        }
        
        // Recommendation
        if (enrichment.recommendation) {
            let bgColor = 'rgba(243, 156, 18, 0.15)';
            let borderColor = 'rgba(243, 156, 18, 0.4)';
            let textColor = '#f39c12';
            
            if (classification === 'Malicious') {
                bgColor = 'rgba(231, 76, 60, 0.15)';
                borderColor = 'rgba(231, 76, 60, 0.4)';
                textColor = '#e74c3c';
            } else if (classification === 'Benign') {
                bgColor = 'rgba(46, 204, 113, 0.15)';
                borderColor = 'rgba(46, 204, 113, 0.4)';
                textColor = '#2ecc71';
            }
            
            html += `
            <div style="
                background: ${bgColor};
                padding: 2rem;
                border-radius: 15px;
                border: 2px solid ${borderColor};
            ">
                <h3 style="
                    color: ${textColor};
                    font-size: 1.5rem;
                    margin-bottom: 1.5rem;
                    display: flex;
                    align-items: center;
                    gap: 0.8rem;
                ">
                    <i class="fas fa-shield-alt"></i> Recommended Action
                </h3>
                <p style="
                    font-size: 1.1rem;
                    font-weight: 600;
                    line-height: 1.8;
                    color: #e2e8f0;
                ">
                    ${enrichment.recommendation}
                </p>
                
                <div style="
                    margin-top: 1.5rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding-top: 1.5rem;
                    border-top: 1px solid rgba(255, 255, 255, 0.1);
                    flex-wrap: wrap;
                    gap: 1rem;
                ">
                    <div>
                        <strong style="color: #94a3b8;">Confidence Level:</strong>
                        <span style="
                            color: ${enrichment.confidence === 'High' ? '#2ecc71' : enrichment.confidence === 'Low' ? '#e74c3c' : '#f39c12'};
                            font-weight: 700;
                            margin-left: 0.5rem;
                            font-size: 1.1rem;
                        ">
                            ${enrichment.confidence || 'Medium'}
                        </span>
                    </div>
                    
                    ${enrichment.risk_score !== undefined ? `
                    <div>
                        <strong style="color: #94a3b8;">Risk Score:</strong>
                        <span style="
                            font-size: 1.3rem;
                            font-weight: 700;
                            margin-left: 0.5rem;
                            color: ${enrichment.risk_score >= 70 ? '#e74c3c' : enrichment.risk_score >= 40 ? '#f39c12' : '#2ecc71'};
                        ">
                            ${enrichment.risk_score}/100
                        </span>
                    </div>
                    ` : ''}
                </div>
            </div>
            `;
        }
        
        return html;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const iocId = "{{ results.ioc_id }}";
        const iocType = "{{ results.type }}";
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
        console.log('🚀 STARTING SEQUENTIAL LAZY LOADING');
        console.log('   IOC ID:', iocId);
        console.log('   IOC Type:', iocType);
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

        const elements = {
            classificationBadge: document.getElementById('classification-badge'),
            otxLoading: document.getElementById('otx-loading'),
            otxContent: document.getElementById('otx-content'),
            otxError: document.getElementById('otx-error'),
            enrichmentWaiting: document.getElementById('enrichment-waiting'),
            enrichmentLoading: document.getElementById('enrichment-loading'),
            enrichmentContent: document.getElementById('enrichment-content'),
            enrichmentError: document.getElementById('enrichment-error')
        };

        console.log('📋 Element Check:');
        Object.entries(elements).forEach(([name, el]) => console.log(`   ${el ? '✅' : '❌'} ${name}`));

        setTimeout(loadOTXData, 500);

        function loadOTXData() {
            console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('📡 STEP 1/3: LOADING OTX DATA');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

            if (!elements.otxLoading) {
                console.error('❌ OTX loading element not found!');
                loadClassification();
                return;
            }

            fetch(`/api/otx/${iocId}`)
                .then(response => {
                    console.log('📥 OTX Response:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('✅ OTX Data Received:', data.status);
                    if (data.status === 'complete' && data.otx_formatted) {
                        elements.otxContent.innerHTML = buildOTXHTML(data.otx_formatted);
                        elements.otxLoading.style.display = 'none';
                        elements.otxContent.style.display = 'block';
                        elements.otxContent.style.opacity = '0';
                        setTimeout(() => {
                            elements.otxContent.style.transition = 'opacity 0.5s ease';
                            elements.otxContent.style.opacity = '1';
                        }, 100);
                    } else {
                        throw new Error(data.error || 'Unknown error from OTX endpoint');
                    }
                    setTimeout(loadClassification, 500);
                })
                .catch(error => {
                    console.error('❌ OTX ERROR:', error);
                    elements.otxLoading.style.display = 'none';
                    if (elements.otxError) {
                        elements.otxError.style.display = 'block';
                        document.getElementById('otx-error-message').textContent = error.message;
                    }
                    setTimeout(loadClassification, 500);
                });
        }

        function loadClassification() {
            console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('🤖 STEP 2/3: RUNNING ML CLASSIFICATION');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

            if (!elements.classificationBadge) {
                console.error('❌ Classification badge not found!');
                renderStaticCharts();
                loadEnrichment();
                return;
            }

            fetch(`/api/classify/${iocId}`)
                .then(response => {
                    console.log('📥 Classification Response:', response.status, response.statusText);
                    return response.json();
                })
                .then(data => {
                    console.log('✅ Classification Data Received:', data.status, data.classification);
                    if (data.status === 'complete' && data.classification && !['Loading...', 'Pending', 'Unknown', ''].includes(data.classification)) {
                        currentClassification = data.classification;
                        elements.classificationBadge.style.opacity = '0';
                        elements.classificationBadge.style.transition = 'opacity 0.3s ease';
                        setTimeout(() => {
                            elements.classificationBadge.className = 'classification ' + currentClassification.toLowerCase();
                            elements.classificationBadge.textContent = currentClassification;
                            elements.classificationBadge.style.opacity = '1';
                        }, 300);
                        renderStaticCharts();
                        setTimeout(loadEnrichment, 2000);
                    } else {
                        console.warn('⚠️ Classification incomplete, retrying...');
                        setTimeout(loadClassification, 1000);
                    }
                })
                .catch(error => {
                    console.error('❌ CLASSIFICATION ERROR:', error);
                    elements.classificationBadge.className = 'classification unknown';
                    elements.classificationBadge.textContent = 'Error';
                    renderStaticCharts();
                    setTimeout(loadEnrichment, 2000);
                });
        }

        let enrichmentRetries = 0;
        const MAX_ENRICHMENT_RETRIES = 10;

        function loadEnrichment() {
            console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log(`🧠 STEP 3/3: LOADING AI ENRICHMENT (Attempt ${enrichmentRetries + 1}/${MAX_ENRICHMENT_RETRIES})`);
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');

            if (!elements.enrichmentLoading) {
                console.error('❌ Enrichment loading element not found!');
                return;
            }

            // ✅ Check for pre-loaded enrichment data (from /scan endpoint)
            if (preloadedEnrichment && Object.keys(preloadedEnrichment).length > 0 && preloadedEnrichment.summary) {
                console.log('✅ Using pre-loaded enrichment data from /scan endpoint');
                console.log('📦 Preloaded Enrichment:', preloadedEnrichment);
                
                if (elements.enrichmentWaiting) elements.enrichmentWaiting.style.display = 'none';
                if (elements.enrichmentError) elements.enrichmentError.style.display = 'none';
                elements.enrichmentLoading.style.display = 'none';
                
                const htmlContent = buildEnrichmentHTML(preloadedEnrichment, currentClassification);
                console.log('🎨 Generated HTML length:', htmlContent.length);
                elements.enrichmentContent.innerHTML = htmlContent;
                elements.enrichmentContent.style.display = 'block';
                elements.enrichmentContent.style.opacity = '0';
                setTimeout(() => {
                    elements.enrichmentContent.style.transition = 'opacity 0.5s ease';
                    elements.enrichmentContent.style.opacity = '1';
                }, 100);
                console.log('\n🎉 ALL STEPS COMPLETED SUCCESSFULLY (using preloaded data)!');
                return;
            }

            // ✅ Otherwise, fetch via AJAX (for /index endpoint)
            if (elements.enrichmentWaiting) elements.enrichmentWaiting.style.display = 'none';
            if (elements.enrichmentError) elements.enrichmentError.style.display = 'none';
            elements.enrichmentLoading.style.display = 'block';

            fetch(`/api/enrichment/${iocId}`)
                .then(response => {
                    console.log('📥 Enrichment Response:', response.status, response.statusText);
                    if (response.status === 400) {
                        enrichmentRetries += 1;
                        if (enrichmentRetries < MAX_ENRICHMENT_RETRIES) {
                            const loadingText = document.getElementById('enrichment-loading-text');
                            if (loadingText) {
                                loadingText.innerHTML = `<i class="fas fa-hourglass-half"></i> Waiting for classification... (Attempt ${enrichmentRetries}/${MAX_ENRICHMENT_RETRIES})`;
                            }
                            setTimeout(loadEnrichment, 3000);
                            return null;
                        }
                        throw new Error('Classification did not complete after maximum retries');
                    }
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || `Server error: ${response.status}`); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return;
                    console.log('✅ Enrichment Data Received:', data.status);
                    console.log('📦 Enrichment Object:', data.enrichment);
                    console.log('   Keys:', data.enrichment ? Object.keys(data.enrichment) : 'null');
                    console.log('   Summary:', data.enrichment?.summary);
                    console.log('   Why Malicious:', data.enrichment?.why_malicious);
                    console.log('   Recommendation:', data.enrichment?.recommendation);
                    if (data.status === 'complete' && data.enrichment) {
                        const htmlContent = buildEnrichmentHTML(data.enrichment, currentClassification);
                        console.log('🎨 Generated HTML length:', htmlContent.length);
                        console.log('🎨 Generated HTML preview:', htmlContent.substring(0, 200));
                        elements.enrichmentContent.innerHTML = htmlContent;
                        elements.enrichmentLoading.style.display = 'none';
                        elements.enrichmentContent.style.display = 'block';
                        elements.enrichmentContent.style.opacity = '0';
                        setTimeout(() => {
                            elements.enrichmentContent.style.transition = 'opacity 0.5s ease';
                            elements.enrichmentContent.style.opacity = '1';
                        }, 100);
                        console.log('\n🎉 ALL STEPS COMPLETED SUCCESSFULLY!');
                    } else {
                        throw new Error(data.error || 'Invalid enrichment data structure');
                    }
                })
                .catch(error => {
                    if (enrichmentRetries >= MAX_ENRICHMENT_RETRIES) {
                        console.error('❌ ENRICHMENT ERROR (final):', error);
                        elements.enrichmentLoading.style.display = 'none';
                        elements.enrichmentError.style.display = 'block';
                        document.getElementById('enrichment-error-message').textContent = error.message;
                    } else {
                        console.log('⚠️ Temporary enrichment error, retrying:', error.message);
                    }
                });
        }
    });
    </script>
</body>
</html>